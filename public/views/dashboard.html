<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gia Ph·∫£ Online - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style/style.css">
    <style>
@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* ‚úÖ Searchable Select Styles (Dropdown t√¨m ki·∫øm) */
.search-select-container {
    position: relative;
}
.search-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}
.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.search-item {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
.floating-tree-btn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: white;
    color: #333;
    border: 1px solid #ddd;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 90; /* Th·∫•p h∆°n modal/notification */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
}
.floating-tree-btn:hover {
    transform: scale(1.1);
    background: #f9fafb;
    color: var(--primary);
}
.floating-tree-btn:active {
    transform: scale(0.95);
}
.search-item:hover {
    background-color: #f3f4f6;
}
.search-item small {
    color: #666;
    display: block;
    font-size: 0.85em;
}
</style>
</head>
<body class="dashboard-page">
    <!-- HEADER -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-sitemap"></i>
                </div>
                <div class="header-info">
                    <h1>Gia Ph·∫£ Online</h1>
                    <p class="user-role" id="userRole"></p>
                </div>
            </div>
            <div class="header-right">
                <span class="user-name" id="userName"></span>
                <button class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                </button>
            </div>
        </div>
    </header>

    <!-- TABS -->
    <div class="tabs-container">
        <button class="tab-btn active" data-tab="dashboard" data-target="#dashboard">
            <i class="fas fa-chart-line"></i> Dashboard
        </button>
        <button class="tab-btn" data-tab="tree" data-target="#tree">
            <i class="fas fa-sitemap"></i> C√¢y Gia Ph·∫£
        </button>
        <button class="tab-btn" data-tab="members" data-target="#members">
            <i class="fas fa-users"></i> Th√†nh vi√™n
        </button>
        <button class="tab-btn" data-tab="posts" data-target="#posts">
            <i class="fas fa-newspaper"></i> B√†i Vi·∫øt
        </button>
        <button class="tab-btn" data-tab="settings" data-target="#settings">
            <i class="fas fa-cog"></i> C√†i ƒê·∫∑t
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f97316, #fbbf24);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>T·ªïng Th√†nh Vi√™n</h3>
                        <div class="stat-number" id="totalMembers">0</div>
                        <span class="stat-change positive">Ng∆∞·ªùi</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0ea5e9);">
                        <i class="fas fa-male"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Nam</h3>
                        <div class="stat-number" id="maleCount">0</div>
                        <span class="stat-change positive" id="malePercent">none</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ec4899, #f43f5e);">
                        <i class="fas fa-female"></i>
                    </div>
                    <div class="stat-info">
                        <h3>N·ªØ</h3>
                        <div class="stat-number" id="femaleCount">0</div>
                        <span class="stat-change positive" id="femalePercent">none</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #34d399);">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Th·∫ø H·ªá</h3>
                        <div class="stat-number" id="generationCount">0</div>
                        <span class="stat-change positive">ƒê·ªùi</span>
                    </div>
                </div>
            </div>

            <!-- GENERATION CHART -->
            <div class="tree-section">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                    <i class="fas fa-chart-bar" style="color: var(--primary);"></i> Ph√¢n B·ªë Th·∫ø H·ªá
                </h3>
                <div id="generationChart"></div>
            </div>

            <!-- BIRTHDAYS, DEATH ANNIVERSARIES & ACTIVITIES -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 30px;">
                <!-- Card sinh nh·∫≠t -->
                <div class="tree-section">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-birthday-cake" style="color: var(--primary);"></i> 
                        Sinh nh·∫≠t s·∫Øp t·ªõi (45 ng√†y tr·ªü l·∫°i)
                    </h3>
                    <div id="birthdayList" style="display: flex; flex-direction: column; gap: 12px; overflow-y: auto; max-height: 500px;"></div>
                </div>

                <!-- Card ng√†y gi·ªó -->
                <div class="tree-section">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-candle-holder" style="color: #6b7280;"></i> 
                        Ng√†y Gi·ªó s·∫Øp t·ªõi (45 ng√†y tr·ªü l·∫°i)
                    </h3>
                    <div id="deathAnniversaryList" style="display: flex; flex-direction: column; gap: 12px; overflow-y: auto; max-height: 500px;"></div>
                </div>

                <!-- Card ho·∫°t ƒë·ªông -->
                <div class="tree-section">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 18px;">
                        <i class="fas fa-history" style="color: var(--primary);"></i> 
                        Ho·∫°t ƒê·ªông G·∫ßn ƒê√¢y
                    </h3>
                    <div id="activityList" style="display: flex; flex-direction: column; gap: 12px; overflow-y: auto; max-height: 500px;"></div>
                </div>
            </div>
        </div>
        <!-- K·∫æT TH√öC DASHBOARD TAB -->

<!-- FAMILY TREE TAB -->
<div id="tree" class="tab-content">
    <div class="tree-section" style="position: relative;">
        <div class="tree-controls">
            <!-- Dropdown ch·ªçn ng∆∞·ªùi -->
            <select id="personSelect" class="btn-control" style="min-width: 300px; background-color: #fff; color: #1f2937; border: 1px solid #d1d5db;" onchange="showSelectedPersonTree()">
                <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
            </select>
            
            <!-- N√∫t hi·ªÉn th·ªã c√¢y -->
            <button class="btn-control" onclick="showSelectedPersonTree()">
                <i class="fas fa-sitemap"></i> Hi·ªÉn th·ªã C√¢y
            </button>
              <!-- üÜï N√öT XEM TO√ÄN B·ªò -->
    <button class="btn-control" onclick="showFullFamilyTree()" 
            style="background: linear-gradient(135deg, #10b981, #34d399); font-weight: 600;">
        <i class="fas fa-project-diagram"></i> Xem to√†n b·ªô C√¢y
    </button>
            <!-- C√°c n√∫t c≈© gi·ªØ nguy√™n -->
            <button class="btn-control" onclick="resetZoom()">
                <i class="fas fa-redo"></i> ƒê·∫∑t l·∫°i
            </button>
            <button class="btn-control" onclick="downloadTree()">
                <i class="fas fa-download"></i> T·∫£i xu·ªëng
            </button>
        </div>
        
        <!-- SVG Canvas -->
        <svg id="familyTreeSvg" style="width: 100%; height: 80vh; min-height: 600px; border: 2px solid #fed7aa; border-radius: 16px; background: linear-gradient(135deg, #fffbf0, #fef3c7, #fff7ed); touch-action: none;"></svg>
        
        <!-- üÜï N√∫t n·ªïi Reset View (V·ªÅ trung t√¢m) -->
        <button class="floating-tree-btn" onclick="resetTreeToCenter()" title="V·ªÅ trung t√¢m">
            <i class="fas fa-crosshairs"></i>
        </button>
    </div>
</div>

        <!-- MEMBERS TAB -->
        <div id="members" class="tab-content">
            <div class="tree-section">
                <!-- N·ªôi dung danh s√°ch th√†nh vi√™n -->
                <div class="members-header">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm th√†nh vi√™n...">
                    </div>
                    <!-- ‚úÖ Th√™m b·ªô l·ªçc lo·∫°i th√†nh vi√™n -->
                    <select id="filterMemberType" class="btn-control" style="padding: 8px 12px; border-radius: 20px; border: 1px solid #e5e7eb; outline: none; cursor: pointer;">
                        <option value="all">-- T·∫•t c·∫£ th√†nh vi√™n --</option>
                        <option value="blood">ü©∏ Huy·∫øt th·ªëng (Con ru·ªôt)</option>
                        <option value="in_law">üë∞ D√¢u / R·ªÉ (V·ª£ ch·ªìng)</option>
                    </select>
                    <button class="btn-add" onclick="openAdvancedSearch()" style="background: linear-gradient(135deg, #06b6d4, #0ea5e9);">
                        <i class="fas fa-filter"></i> T√¨m N√¢ng Cao
                    </button>
                    <button class="btn-add" onclick="openAddMemberModal()">
                        <i class="fas fa-plus"></i> Th√™m Th√†nh vi√™n
                    </button>
                </div>
                <div class="members-grid" id="membersGrid"></div>
            </div>
        </div>
   <!-- ==========================================
             POSTS TAB - B√ÄI VI·∫æT
             ========================================== -->
        <div id="posts" class="tab-content">
            <div class="tree-section">
                <div class="members-header">
                    <h2 style="font-size: 20px; margin: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-newspaper" style="color: var(--primary);"></i>
                        B√†i Vi·∫øt & Th√¥ng B√°o
                    </h2>
                    <button class="btn-add" onclick="openCreatePostModal()">
                        <i class="fas fa-plus"></i> T·∫°o B√†i vi·∫øt
                    </button>
                </div>

                <!-- Danh s√°ch b√†i vi·∫øt -->
                <div id="postsGrid" style="display: grid; gap: 20px; margin-top: 24px;"></div>

                <!-- Empty state -->
                <div id="postsEmptyState" style="display:none; text-align: center; padding: 60px 20px; color: #999;">
                    <i class="fas fa-newspaper" style="font-size: 64px; color: #e5e7eb; margin-bottom: 16px;"></i>
                    <p style="font-size: 16px; margin-bottom: 8px;">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
                    <p style="font-size: 14px; margin-bottom: 20px;">Chia s·∫ª th√¥ng tin, s·ª± ki·ªán v·ªõi gia ƒë√¨nh</p>
                    <button class="btn-add" onclick="openCreatePostModal()">
                        <i class="fas fa-plus"></i> T·∫°o B√†i vi·∫øt ƒë·∫ßu ti√™n
                    </button>
                </div>
            </div>
        </div>
        <!-- K·∫æT TH√öC POSTS TAB -->
        <!-- SETTINGS TAB -->
<!-- SETTINGS TAB -->
<div id="settings" class="tab-content">
    <div class="tree-section">
        <h2 style="margin-bottom: 24px; font-size: 20px;">‚öôÔ∏è C√†i ƒë·∫∑t & C√¥ng c·ª•</h2>
        
        <!-- Grid ch·ª©a c√°c card -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px;">
            
            <!-- Card 1: Xu·∫•t PDF -->
            <div class="settings-card" onclick="exportPDF()">
                <i class="fas fa-file-pdf" style="font-size: 48px; color: #ef4444;"></i>
                <h3>üì• Xu·∫•t PDF</h3>
                <p>Xu·∫•t to√†n b·ªô gia ph·∫£ th√†nh file PDF</p>
                <small style="color: #999;">Bao g·ªìm t·∫•t c·∫£ th√†nh vi√™n v√† th·ªëng k√™</small>
            </div>

            <!-- Card 2: Import CSV -->
            <div class="settings-card" onclick="importData()">
                <i class="fas fa-file-upload" style="font-size: 48px; color: #10b981;"></i>
                <h3>üì§ Nh·∫≠p D·ªØ Li·ªáu</h3>
                <p>Import th√†nh vi√™n t·ª´ file CSV</p>
                <button onclick="event.stopPropagation(); downloadSampleCSV()" 
                        style="margin-top: 8px; padding: 6px 12px; background: #e5e7eb; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    ‚¨áÔ∏è T·∫£i file m·∫´u
                </button>
            </div>

            <!-- Card 3: Reset d·ªØ li·ªáu -->
            <div class="settings-card" onclick="resetData()" style="border-left-color: #ef4444;">
                <i class="fas fa-redo" style="font-size: 48px; color: #f97316;"></i>
                <h3>üîÑ Kh√¥i Ph·ª•c M·∫´u</h3>
                <p>X√≥a to√†n b·ªô v√† load l·∫°i d·ªØ li·ªáu m·∫´u</p>
                <small style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è H√†nh ƒë·ªông kh√¥ng th·ªÉ ho√†n t√°c!</small>
            </div>
            <!-- Card 3: X√≥a to√†n b·ªô th√†nh vi√™n -->
<div class="settings-card" id="deleteAllMembersCard" onclick="deleteAllMembers()" style="display:none; border-left-color: #dc2626;">
    <i class="fas fa-user-slash" style="font-size: 48px; color: #dc2626;"></i>
    <h3>üóëÔ∏è X√≥a To√†n B·ªô Th√†nh Vi√™n</h3>
    <p>X√≥a T·∫§T C·∫¢ th√†nh vi√™n kh·ªèi gia ph·∫£</p>
    <small style="color: #dc2626; font-weight: 600;">‚ö†Ô∏è Ch·ªâ Admin, kh√¥ng th·ªÉ ho√†n t√°c!</small>
</div>
<div class="settings-card" id="clearLogsCard" onclick="clearAllActivityLogs()" style="display:none; border-left-color: #ef4444;">
    <i class="fas fa-trash-alt" style="font-size: 48px; color: #ef4444;"></i>
    <h3>üóëÔ∏è X√≥a L·ªãch S·ª≠</h3>
    <p>X√≥a to√†n b·ªô l·ªãch s·ª≠ ho·∫°t ƒë·ªông</p>
    <small style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è Ch·ªâ Admin, kh√¥ng th·ªÉ ho√†n t√°c!</small>
</div>
            <!-- Card 4: Th√¥ng tin h·ªá th·ªëng -->
            <div class="settings-card" style="cursor: default; opacity: 0.8;">
                <i class="fas fa-info-circle" style="font-size: 48px; color: #3b82f6;"></i>
                <h3>‚ÑπÔ∏è Th√¥ng Tin</h3>
                <p style="font-size: 13px; color: #666;">
                    Version: 2.0.0<br>
                    Database: MongoDB<br>
                    Owner ID: <span id="ownerIdDisplay">-</span>
                </p>
            </div>
            <!-- Card 5: Qu·∫£n l√Ω Viewer (CH·ªà HI·ªÜN V·ªöI ADMIN) -->
<div class="settings-card" id="viewerManagementCard" onclick="openViewerManagement()" style="display:none;">
    <i class="fas fa-users-cog" style="font-size: 48px; color: #8b5cf6;"></i>
    <h3>üë• Qu·∫£n L√Ω Viewer</h3>
    <p>T·∫°o v√† qu·∫£n l√Ω t√†i kho·∫£n xem gia ph·∫£</p>
    <small style="color: #999;">C·∫•p quy·ªÅn xem cho ng∆∞·ªùi kh√°c</small>
</div>
        </div>
        <!-- K·∫øt th√∫c grid -->

     <!-- Thay th·∫ø ph·∫ßn h∆∞·ªõng d·∫´n c≈© b·∫±ng ƒëo·∫°n n√†y -->
<div style="margin-top: 40px; padding: 24px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9; border-radius: 12px;">
    <h3 style="margin-bottom: 16px; color: #0369a1; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-file-csv"></i> üìã H∆∞·ªõng D·∫´n Import CSV ƒê·∫ßy ƒê·ªß
    </h3>
    
    <!-- C·∫•u tr√∫c file -->
    <div style="margin-bottom: 20px;">
        <h4 style="color: #0284c7; margin-bottom: 8px;">üìå C√°c c·ªôt B·∫ÆT BU·ªòC:</h4>
        <ul style="color: #374151; line-height: 1.8; margin-left: 20px;">
            <li><code style="background: #fff; padding: 2px 6px; border-radius: 4px; color: #dc2626;">full_name</code> - H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß</li>
            <li><code style="background: #fff; padding: 2px 6px; border-radius: 4px; color: #dc2626;">gender</code> - Gi·ªõi t√≠nh: <strong>"Nam"</strong> ho·∫∑c <strong>"N·ªØ"</strong></li>
           
        </ul>
    </div>

    <div style="margin-bottom: 20px;">
        <h4 style="color: #0284c7; margin-bottom: 8px;">üîß C√°c c·ªôt T√ôY CH·ªåN:</h4>
        <ul style="color: #374151; line-height: 1.8; margin-left: 20px;">
            <li><code>birth_date</code> - Ng√†y sinh (YYYY-MM-DD) 
        <strong style="color: #f97316;">ho·∫∑c "unknown" n·∫øu kh√¥ng r√µ</strong>
    </li>
    <li><code>death_date</code> - Ng√†y m·∫•t (YYYY-MM-DD) 
        <strong style="color: #f97316;">ho·∫∑c "unknown" n·∫øu kh√¥ng r√µ</strong>
    </li>
            <li><code>generation</code> - Th·∫ø h·ªá (1, 2, 3...)</li>
            <li><code>notes</code> - Ghi ch√∫</li>
            <li><code>phone</code> - S·ªë ƒëi·ªán tho·∫°i</li>
            <li><code>job</code> - Ngh·ªÅ nghi·ªáp</li>
            <li><code>address</code> - ƒê·ªãa ch·ªâ</li>
            <li><code style="background: #fef3c7; padding: 2px 6px; border-radius: 4px; color: #f97316;">parent_name</code> - ‚≠ê H·ªç t√™n cha/m·∫π (ƒë·ªÉ tr·ªëng n·∫øu th·ªßy t·ªï)</li>
            <li><code style="background: #fef3c7; padding: 2px 6px; border-radius: 4px; color: #f97316;">spouse_name</code> - ‚≠ê H·ªç t√™n v·ª£/ch·ªìng (ƒë·ªÉ tr·ªëng n·∫øu ch∆∞a c√≥)</li>
        </ul>
    </div>
    
    <!-- L∆∞u √Ω quan tr·ªçng -->
   <div style="margin-top: 20px; padding: 16px; background: #fff7ed; border-radius: 8px; border: 2px solid #fed7aa;">
    <p style="color: #c2410c; font-weight: 700; margin-bottom: 12px; font-size: 16px;">
        ‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG V·ªÄ TH·∫æ H·ªÜ:
    </p>
    <ul style="color: #9a3412; font-size: 14px; margin-left: 20px; line-height: 1.8;">
        <li><strong>‚úÖ Th·∫ø h·ªá ƒë∆∞·ª£c T·ª∞ ƒê·ªòNG T√çNH:</strong>
            <ul style="margin-left: 20px; margin-top: 4px;">
                <li>N·∫øu c√≥ <code>parent_name</code> ‚Üí Th·∫ø h·ªá = Th·∫ø h·ªá cha/m·∫π + 1</li>
                <li>N·∫øu ch·ªâ c√≥ <code>spouse_name</code> ‚Üí Th·∫ø h·ªá = Th·∫ø h·ªá v·ª£/ch·ªìng</li>
                <li>Th·ªßy t·ªï (ƒë·ªùi 1) ‚Üí ƒê·ªÉ <code>generation=1</code> v√† <code>parent_name</code> tr·ªëng</li>
            </ul>
        </li>
        <li><strong>‚ö†Ô∏è Quy t·∫Øc b·∫Øt bu·ªôc:</strong>
            <ul style="margin-left: 20px; margin-top: 4px;">
                <li>Th·ªßy t·ªï: <code>generation=1</code>, KH√îNG ƒë∆∞·ª£c c√≥ <code>parent_name</code></li>
                <li>ƒê·ªùi > 1: Ph·∫£i c√≥ <code>parent_name</code> HO·∫∂C <code>spouse_name</code></li>
                <li>T√™n trong <code>parent_name</code> v√† <code>spouse_name</code> ph·∫£i kh·ªõp CH√çNH X√ÅC</li>
            </ul>
        </li>
        <li><strong>üìå Th·ª© t·ª± import:</strong> Ph·∫£i import cha/m·∫π TR∆Ø·ªöC, con SAU</li>
    </ul>
</div>

    <!-- V√≠ d·ª• th·ª±c t·∫ø -->
    <div style="margin-top: 20px; padding: 16px; background: #f3f4f6; border-radius: 8px; border-left: 4px solid #6b7280;">
        <p style="color: #374151; font-weight: 600; margin-bottom: 8px;">üìù V√ç D·ª§ D√íNG CSV:</p>
        <pre style="background: #fff; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 12px; color: #1f2937;">Nguy·ªÖn VƒÉn A,Nam,1880-01-15,1945-08-20,1,Th·ªßy t·ªï,,N√¥ng d√¢n,H√† N·ªôi,,Tr·∫ßn Th·ªã B
Tr·∫ßn Th·ªã B,N·ªØ,1885-03-10,1952-06-12,1,V·ª£ c·ª• A,,D·ªát v·∫£i,H√† N·ªôi,,Nguy·ªÖn VƒÉn A
Nguy·ªÖn VƒÉn C,Nam,1930-01-25,,2,Con tr∆∞·ªüng,,K·ªπ s∆∞,H√† N·ªôi,Nguy·ªÖn VƒÉn A,L√™ Th·ªã D</pre>
    </div>
    
    <p style="margin-top: 16px; color: #6b7280; font-style: italic; font-size: 14px;">
        üí° <strong>Tip:</strong> Click n√∫t <strong>"T·∫£i file m·∫´u"</strong> ƒë·ªÉ c√≥ file CSV ho√†n ch·ªânh v·ªõi d·ªØ li·ªáu m·∫´u.
    </p>
</div>
        <!-- K·∫øt th√∫c h∆∞·ªõng d·∫´n -->

    </div>
</div>
<!-- K·∫øt th√∫c SETTINGS TAB -->
    <!-- MEMBER DETAIL MODAL -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Th√¥ng Tin Th√†nh Vi√™n</h2>
                <button class="close-btn" onclick="closeMemberModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="memberDetailContent"></div>
        </div>
    </div>

    <!-- ADD/EDIT MEMBER MODAL -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addModalTitle">Th√™m Th√†nh Vi√™n</h2>
                <button class="close-btn" onclick="closeAddMemberModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="memberForm" style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>H·ªç v√† T√™n *</label>
                            <input type="text" id="memberName" required>
                        </div>
                        <div class="form-group">
                            <label>Gi·ªõi T√≠nh</label>
                            <select id="memberGender">
                                <option value="male">Nam</option>
                                <option value="female">N·ªØ</option>
                            </select>
                        </div>
                    </div>

                   <div class="form-row">
    <div class="form-group">
        <label>Ng√†y Sinh</label>
        <input type="date" id="memberBirth" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng r√µ">
        <small style="color: #6b7280; font-size: 11px; display: block; margin-top: 4px;">
            üí° C√≥ th·ªÉ ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng bi·∫øt ch√≠nh x√°c
        </small>
    </div>
    <div class="form-group">
        <label>Ng√†y M·∫•t</label>
        <input type="date" id="memberDeath" placeholder="ƒê·ªÉ tr·ªëng n·∫øu c√≤n s·ªëng ho·∫∑c kh√¥ng r√µ">
        <div style="margin-top: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                <input type="checkbox" id="isDeceasedUnknown" style="width: auto;">
                <span style="font-size: 13px;">‚òëÔ∏è ƒê√£ m·∫•t nh∆∞ng kh√¥ng r√µ ng√†y</span>
            </label>
        </div>
    </div>
</div>

                    <div class="form-row">
    <div class="form-group">
        <label>S·ªë ƒêi·ªán Tho·∫°i</label>
        <input type="tel" id="memberPhone" placeholder="0912345678">
    </div>
    <div class="form-group">
        <label>Th·ª© T·ª± (Con th·ª©)</label>
        <input type="number" id="memberOrder" placeholder="1, 2, 3...">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label>
            Th·∫ø H·ªá 
            <span style="color: #f97316; font-size: 11px;">(T·ª± ƒë·ªông t√≠nh)</span>
        </label>
        <select id="memberGeneration" disabled>
            <option value="1">Th·∫ø h·ªá 1 (Th·ªßy t·ªï)</option>
        </select>
    </div>
    <div class="form-group">
        <label>Ngh·ªÅ Nghi·ªáp</label>
        <input type="text" id="memberJob" placeholder="V√≠ d·ª•: N√¥ng d√¢n">
    </div>
</div>
                    <div class="form-group">
                        <label>ƒê·ªãa Ch·ªâ</label>
                        <input type="text" id="memberAddress" placeholder="V√≠ d·ª•: Qu·∫£ng Tr·ªã">
                    </div>
                    <div class="form-group">
                        <label>Ghi Ch√∫ / M·ªëi Quan H·ªá</label>
                        <textarea id="memberNote" placeholder="V√≠ d·ª•: √îng ngo√†i, B√†, v.v."></textarea>
                    </div>

                  <div class="form-row">
    <div class="form-group">
        <label>
            Cha/M·∫π 
            <span style="color: #f97316; font-size: 11px;">(B·∫Øt bu·ªôc n·∫øu ƒë·ªùi > 1)</span>
        </label>
        <div class="search-select-container">
            <input type="text" id="memberParentSearch" class="search-input" placeholder="G√µ t√™n ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
            <input type="hidden" id="memberParent">
            <div id="memberParentResults" class="search-results"></div>
        </div>
    </div>
    <div class="form-group">
        <label>V·ª£/Ch·ªìng</label>
        <div class="search-select-container">
            <input type="text" id="memberSpouseSearch" class="search-input" placeholder="G√µ t√™n ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
            <input type="hidden" id="memberSpouse">
            <div id="memberSpouseResults" class="search-results"></div>
        </div>
        <small style="color: #6b7280; font-size: 11px; display: block; margin-top: 4px;">
            üí° Ch·ªçn t·ª´ danh s√°ch ƒë√£ c√≥. N·∫øu ch∆∞a c√≥, h√£y <strong>Th√™m th√†nh vi√™n m·ªõi</strong> cho v·ª£/ch·ªìng ƒë√≥.
        </small>
    </div>
</div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeAddMemberModal()">H·ªßy</button>
                        <button type="submit" class="btn-save">L∆∞u Th√†nh Vi√™n</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ADVANCED SEARCH MODAL -->
    <div id="advancedSearchModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üîç T√¨m Ki·∫øm N√¢ng Cao</h2>
                <button class="close-btn" onclick="closeAdvancedSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="advancedSearchForm" style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="form-group">
                        <label>H·ªç v√† T√™n</label>
                        <input type="text" id="searchName" placeholder="Nh·∫≠p t√™n th√†nh vi√™n...">
                    </div>

                    <div class="form-row">
                       <div class="form-group">
    <label>Th·∫ø H·ªá</label>
    <select id="searchGeneration">
        <option value="">-- T·∫•t c·∫£ --</option>
        <!-- C√°c option s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông b·∫±ng JavaScript -->
    </select>
</div>
                        <div class="form-group">
                            <label>Gi·ªõi T√≠nh</label>
                            <select id="searchGender">
                                <option value="all">-- T·∫•t c·∫£ --</option>
                                <option value="male">Nam</option>
                                <option value="female">N·ªØ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tr·∫°ng Th√°i</label>
                            <select id="searchStatus">
                                <option value="">-- T·∫•t c·∫£ --</option>
                                <option value="living">ƒêang s·ªëng</option>
                                <option value="deceased">Qu√° c·ªë</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ngh·ªÅ Nghi·ªáp</label>
                            <input type="text" id="searchJob" placeholder="V√≠ d·ª•: Gi√°o vi√™n">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tu·ªïi t·ª´</label>
                            <input type="number" id="searchAgeMin" placeholder="Tu·ªïi t·ªëi thi·ªÉu" min="0" max="150">
                        </div>
                        <div class="form-group">
                            <label>Tu·ªïi ƒë·∫øn</label>
                            <input type="number" id="searchAgeMax" placeholder="Tu·ªïi t·ªëi ƒëa" min="0" max="150">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ƒê·ªãa Ch·ªâ</label>
                        <input type="text" id="searchAddress" placeholder="V√≠ d·ª•: H√† N·ªôi">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="resetAdvancedSearch()">ƒê·∫∑t L·∫°i</button>
                        <button type="button" class="btn-save" onclick="performAdvancedSearch()">T√¨m Ki·∫øm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<!-- ==========================================
     VIEWER MANAGEMENT MODAL
     ========================================== -->
<div id="viewerModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>üë• Qu·∫£n L√Ω Viewer</h2>
            <button class="close-btn" onclick="closeViewerModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- N√∫t t·∫°o viewer m·ªõi -->
            <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                <button class="btn-add" onclick="openCreateViewerForm()">
                    <i class="fas fa-plus"></i> T·∫°o Viewer M·ªõi
                </button>
                <p style="color: #666; font-size: 13px; margin: 0;">
                    <i class="fas fa-info-circle"></i> Viewer ch·ªâ xem ƒë∆∞·ª£c, kh√¥ng th·ªÉ s·ª≠a/x√≥a
                </p>
            </div>

            <!-- Form t·∫°o viewer (·∫©n m·∫∑c ƒë·ªãnh) -->
            <!-- Form t·∫°o viewer (·∫©n m·∫∑c ƒë·ªãnh) -->
<div id="createViewerForm" style="display:none; margin-bottom: 24px; padding: 24px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border-left: 4px solid #0ea5e9;">
    <h3 style="margin-bottom: 16px; color: #0369a1;">
        <i class="fas fa-user-plus"></i> T·∫°o Viewer M·ªõi
    </h3>
    <div class="form-group">
        <label>H·ªç v√† T√™n <span style="color: #ef4444;">*</span></label>
        <input type="text" id="newViewerName" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" required style="font-size: 15px;">
    </div>
    <div class="form-group">
        <label>M·∫≠t Kh·∫©u <span style="color: #ef4444;">*</span></label>
        <input type="password" id="newViewerPassword" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±" required style="font-size: 15px;">
        <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
            <i class="fas fa-info-circle"></i> M·∫≠t kh·∫©u ƒë·ªÉ viewer ƒëƒÉng nh·∫≠p (t·ªëi thi·ªÉu 6 k√Ω t·ª±)
        </small>
    </div>
    <div class="form-actions" style="margin-top: 16px;">
        <button class="btn-cancel" onclick="cancelCreateViewer()">
            <i class="fas fa-times"></i> H·ªßy
        </button>
        <button class="btn-save" onclick="submitCreateViewer()">
            <i class="fas fa-check"></i> T·∫°o Viewer
        </button>
    </div>
</div>

            <!-- Danh s√°ch viewer -->
            <div id="viewerList" style="display: grid; gap: 16px;"></div>

            <!-- Empty state -->
            <div id="viewerEmptyState" style="display:none; text-align: center; padding: 60px 20px; color: #999;">
                <i class="fas fa-users" style="font-size: 64px; color: #e5e7eb; margin-bottom: 16px;"></i>
                <p style="font-size: 16px; margin-bottom: 8px;">Ch∆∞a c√≥ viewer n√†o</p>
                <p style="font-size: 14px;">Click "T·∫°o Viewer M·ªõi" ƒë·ªÉ c·∫•p quy·ªÅn xem cho ng∆∞·ªùi kh√°c</p>
            </div>
        </div>
    </div>
</div>
<!-- ==========================================
     CREATE/EDIT POST MODAL
     ========================================== -->
<div id="postModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="postModalTitle">‚úçÔ∏è T·∫°o B√†i Vi·∫øt</h2>
            <button class="close-btn" onclick="closePostModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="postForm">
                <!-- Ti√™u ƒë·ªÅ -->
                <div class="form-group">
                    <label>Ti√™u ƒë·ªÅ <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="postTitle" required placeholder="V√≠ d·ª•: Th√¥ng b√°o h·ªçp m·∫∑t gia ƒë√¨nh">
                </div>

                <!-- Danh m·ª•c v√† Ghim -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Danh m·ª•c</label>
                        <select id="postCategory">
                            <option value="announcement">üì¢ Th√¥ng b√°o</option>
                            <option value="event">üéâ S·ª± ki·ªán</option>
                            <option value="news">üì∞ Tin t·ª©c</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="postPinned" style="width: auto;">
                            üìå Ghim b√†i vi·∫øt l√™n ƒë·∫ßu
                        </label>
                    </div>
                </div>

                <!-- N·ªôi dung -->
                <div class="form-group">
                    <label>N·ªôi dung <span style="color: #ef4444;">*</span></label>
                    <textarea id="postContent" required placeholder="Nh·∫≠p n·ªôi dung b√†i vi·∫øt..." style="min-height: 250px;"></textarea>
                    <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                        <i class="fas fa-info-circle"></i> H·ªó tr·ª£ xu·ªëng d√≤ng v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
                    </small>
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closePostModal()">
                        <i class="fas fa-times"></i> H·ªßy
                    </button>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-check"></i> L∆∞u B√†i Vi·∫øt
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ==========================================
     VIEW POST MODAL
     ========================================== -->
<div id="viewPostModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="viewPostTitle"></h2>
            <button class="close-btn" onclick="closeViewPostModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Metadata -->
            <div id="viewPostMeta" style="display: flex; gap: 16px; padding: 12px 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; font-size: 13px; color: #6b7280;"></div>
            
            <!-- Content -->
            <div id="viewPostContent" style="line-height: 1.8; white-space: pre-wrap;"></div>

            <!-- Actions -->
            <div id="viewPostActions" style="display: flex; gap: 12px; margin-top: 24px; padding-top: 20px; border-top: 2px solid #e5e7eb;"></div>
        </div>
    </div>
</div>
   <!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="/components/familyTreeRenderer.js"></script>
<script>
    // --- LOGIC DASHBOARD (INLINE) ---

    // Bi·∫øn to√†n c·ª•c l∆∞u danh s√°ch th√†nh vi√™n ƒë·ªÉ d√πng cho dropdown t√¨m ki·∫øm
    let allMembers = [];
    let editingMemberId = null;

    // ‚úÖ TH√äM C√ÅC H√ÄM C√íN THI·∫æU
    function ensureAuth() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = "/login";
            return false;
        }
        return true;
    }

    function showViewerNotice() {
        const userRole = localStorage.getItem('userRole');
        if (userRole === 'viewer') {
            // C√≥ th·ªÉ hi·ªÉn th·ªã th√¥ng b√°o ch√†o m·ª´ng viewer n·∫øu c·∫ßn
            console.log('Viewer mode active');
        }
    }

    function hideSettingsForViewer() {
        const userRole = localStorage.getItem('userRole');
        if (userRole === 'viewer') {
            // ·∫®n c√°c n√∫t import/reset ƒë·ªëi v·ªõi viewer (n·∫øu c√≥ ID)
            // Hi·ªán t·∫°i logic server ƒë√£ ch·∫∑n, ƒë√¢y ch·ªâ l√† UI
        }
    }

    function showViewerManagementIfAdmin() {
        const userRole = localStorage.getItem('userRole');
        if (userRole === 'owner') {
            const viewerCard = document.getElementById('viewerManagementCard');
            if (viewerCard) viewerCard.style.display = 'block';
            const clearLogsCard = document.getElementById('clearLogsCard');
            if (clearLogsCard) clearLogsCard.style.display = 'block';
            const deleteAllCard = document.getElementById('deleteAllMembersCard');
            if (deleteAllCard) deleteAllCard.style.display = 'block';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Hi·ªÉn th·ªã th√¥ng tin user
        const userStr = localStorage.getItem('user');
        
        if (userStr) {
            try {
                const user = JSON.parse(userStr);
                if(document.getElementById('userName')) document.getElementById('userName').textContent = user.full_name || user.username;
                if(document.getElementById('userRole')) document.getElementById('userRole').textContent = user.role === 'owner' ? 'Admin' : 'Viewer';
            } catch (e) {
                console.error("L·ªói parse user", e);
                window.location.href = '/login';
            }
        } else {
            // N·∫øu kh√¥ng c√≥ user nh∆∞ng c√≥ authToken th√¨ t·∫°m ch·∫•p nh·∫≠n (ho·∫∑c ƒë√° v·ªÅ login)
            if (!localStorage.getItem('authToken')) window.location.href = '/login';
        }

        // 2. X·ª≠ l√Ω Tab
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const target = document.querySelector(tab.dataset.target);
                if (target) target.classList.add('active');

                // Load d·ªØ li·ªáu khi chuy·ªÉn tab
                if (tab.dataset.tab === 'members') loadMembers();
                if (tab.dataset.tab === 'dashboard') loadStats();
                if (tab.dataset.tab === 'tree') initTree(); // Kh·ªüi t·∫°o c√¢y khi b·∫•m tab
                if (tab.dataset.tab === 'tree') {
                    // Kh·ªüi t·∫°o c√¢y ho·∫∑c hi·ªÉn th·ªã l·∫°i to√†n b·ªô n·∫øu ƒë√£ c√≥
                    initTree().then(() => {
                        if (treeRenderer) showFullFamilyTree();
                    });
                }
                // ‚úÖ Load b√†i vi·∫øt khi chuy·ªÉn tab
                if (tab.dataset.tab === 'posts') loadPosts();
            });
        });

        // 3. Logout
        document.querySelector('.btn-logout').addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = '/login';
        });

        // Load m·∫∑c ƒë·ªãnh
        loadStats();
        loadMembers();
        initTree(); // Th·ª≠ kh·ªüi t·∫°o c√¢y ngay (·∫©n)
        setupSimpleSearch(); // K√≠ch ho·∫°t t√¨m ki·∫øm

        // G√°n s·ª± ki·ªán submit form
        const memberForm = document.getElementById('memberForm');
        if (memberForm) memberForm.addEventListener('submit', submitMemberForm);

        // ‚úÖ G√°n s·ª± ki·ªán submit form b√†i vi·∫øt (QUAN TR·ªåNG)
        const postForm = document.getElementById('postForm');
        if (postForm) postForm.addEventListener('submit', submitPostForm);
    });

    // --- API FUNCTIONS ---

    // Wrapper cho fetch c√≥ auth
    async function apiCall(url, method = 'GET', body = null) {
        const token = localStorage.getItem('authToken');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const opts = { method, headers };
        if (body) opts.body = JSON.stringify(body);

        const res = await fetch(url, opts);
        if (res.status === 401) {
            window.location.href = '/login';
            return null;
        }
        return res.json();
    }

    async function loadStats() {
        try {
            const res = await fetch('/api/dashboard/stats');
            if (res.ok) {
                const data = await res.json();
                // C·∫≠p nh·∫≠t ƒë·ªÉ kh·ªõp v·ªõi format { success: true, stats: { total, males, females... } }
                if (data.success && data.stats) {
                    const s = data.stats;
                    if(document.getElementById('totalMembers'))
                        document.getElementById('totalMembers').textContent = s.total || 0;
                    if(document.getElementById('maleCount'))
                        document.getElementById('maleCount').textContent = s.males || 0;
                    if(document.getElementById('femaleCount'))
                        document.getElementById('femaleCount').textContent = s.females || 0;
                    
                    // ‚úÖ FIX: T√≠nh to√°n s·ªë ƒë·ªùi (Generation Count)
                    let maxGen = s.maxGeneration || 0;
                    if (maxGen === 0 && s.generations && Array.isArray(s.generations)) {
                        const gens = s.generations.map(g => g.generation).filter(g => g);
                        if (gens.length) maxGen = Math.max(...gens);
                    }
                    if(document.getElementById('generationCount'))
                        document.getElementById('generationCount').textContent = maxGen;

                    // ‚úÖ FIX: Hi·ªÉn th·ªã % Nam/N·ªØ
                    if (s.total > 0) {
                        if(document.getElementById('malePercent'))
                            document.getElementById('malePercent').textContent = Math.round((s.males/s.total)*100) + '%';
                        if(document.getElementById('femalePercent'))
                            document.getElementById('femalePercent').textContent = Math.round((s.females/s.total)*100) + '%';
                    }

                    // ‚úÖ FIX: V·∫Ω bi·ªÉu ƒë·ªì ph√¢n b·ªë th·∫ø h·ªá
                    renderGenerationPie(s.generations || [], s.total || 0);

                    // ‚úÖ FIX: Hi·ªÉn th·ªã c√°c danh s√°ch kh√°c
                    renderUpcomingBirthdays(s.upcomingBirthdays || []);
                    renderUpcomingDeathAnniversaries(s.upcomingDeathAnniversaries || []);
                    renderRecentActivities(s.activities || []);
                }
            }
        } catch (e) { console.error(e); }
    }

    // --- CHART & LIST RENDERERS ---
    function renderGenerationPie(genDist, total) {
        const container = document.getElementById('generationChart');
        if (!container) return;
        container.innerHTML = '';

        const validGenDist = genDist.filter(item => item.generation);
        if (!validGenDist.length || total <= 0) {
            container.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu th·∫ø h·ªá.';
            return;
        }

        const segments = validGenDist.map(item => ({
            generation: item.generation,
            count: item.count,
            percent: Math.round((item.count / total) * 100)
        }));

        let gradientParts = [];
        let currentDeg = 0;
        const colors = ['#f97316', '#0ea5e9', '#ec4899', '#10b981', '#8b5cf6', '#f43f5e', '#eab308'];

        segments.forEach((seg, idx) => {
            const color = colors[idx % colors.length];
            const deg = (seg.percent / 100) * 360;
            gradientParts.push(`${color} ${currentDeg}deg ${currentDeg + deg}deg`);
            currentDeg += deg;
        });

        const chart = document.createElement('div');
        chart.style.cssText = `width: 200px; height: 200px; border-radius: 50%; background: conic-gradient(${gradientParts.join(',')}); margin: 0 auto; position: relative;`;
        
        // L√µi tr·∫Øng
        const inner = document.createElement('div');
        inner.style.cssText = `position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;`;
        inner.textContent = total;
        chart.appendChild(inner);

        // Legend
        const legend = document.createElement('div');
        legend.style.cssText = `display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px;`;
        
        segments.forEach((seg, idx) => {
            const color = colors[idx % colors.length];
            legend.innerHTML += `
                <div style="display: flex; align-items: center; gap: 5px; font-size: 12px;">
                    <span style="width: 10px; height: 10px; background: ${color}; display: inline-block; border-radius: 2px;"></span>
                    ƒê·ªùi th·ª© ${seg.generation}: ${seg.count}
                </div>
            `;
        });

        container.appendChild(chart);
        container.appendChild(legend);
    }

    function renderUpcomingBirthdays(list) {
        const container = document.getElementById('birthdayList');
        if(!container) return;
        container.innerHTML = list.length ? '' : '<p style="color:#666; font-size:13px;">Kh√¥ng c√≥ sinh nh·∫≠t s·∫Øp t·ªõi.</p>';
        
        list.forEach(item => {
            container.innerHTML += `
                <div style="padding: 10px; background: #fff; border-radius: 8px; border-left: 3px solid #ec4899; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div style="font-weight: 600;">${item.full_name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${item.birthday} (C√≤n ${item.daysLeft} ng√†y)
                    </div>
                </div>
            `;
        });
    }

    function renderUpcomingDeathAnniversaries(list) {
        const container = document.getElementById('deathAnniversaryList');
        if(!container) return;
        container.innerHTML = list.length ? '' : '<p style="color:#666; font-size:13px;">Kh√¥ng c√≥ ng√†y gi·ªó s·∫Øp t·ªõi.</p>';
        
        list.forEach(item => {
            container.innerHTML += `
                <div style="padding: 10px; background: #fff; border-radius: 8px; border-left: 3px solid #6b7280; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div style="font-weight: 600;">${item.full_name}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${item.death_date} (Gi·ªó nƒÉm th·ª© ${item.yearCount})
                    </div>
                </div>
            `;
        });
    }

    function renderRecentActivities(list) {
        const container = document.getElementById('activityList');
        if(!container) return;
        container.innerHTML = list.length ? '' : '<p style="color:#666; font-size:13px;">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</p>';
        
        const userRole = localStorage.getItem('userRole');
        const icons = { 'create': '‚úÖ', 'update': '‚úèÔ∏è', 'delete': 'üóëÔ∏è' };
        
        list.forEach(item => {
            const timeAgo = formatTimeAgo(item.created_at);
            const roleBadge = item.actor_role === 'viewer'
                ? '<span style="background: #dbeafe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 10px;">üëÅÔ∏è Viewer</span>'
                : '<span style="background: #fed7aa; color: #c2410c; padding: 2px 6px; border-radius: 4px; font-size: 10px;">üëë Admin</span>';

            // N√∫t x√≥a ch·ªâ hi·ªán v·ªõi Owner
            const deleteBtn = userRole === 'owner' 
                ? `<button onclick="deleteActivityLog('${item.id || item._id}')" style="border:none; background:none; cursor:pointer; color:#ef4444; font-size:12px; padding: 4px;" title="X√≥a"><i class="fas fa-trash"></i></button>`
                : '';

            container.innerHTML += `
                <div style="padding: 12px; background: #fff; border-radius: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
                            <span>${icons[item.action_type] || 'üìù'}</span>
                            <span>${item.description}</span>
                        </div>
                        <div style="font-size: 11px; color: #666; display: flex; align-items: center; gap: 6px;">
                            <span style="font-weight: 500;">${item.actor_name}</span>
                            ${roleBadge}
                            <span style="color: #9ca3af;">‚Ä¢ ${timeAgo}</span>
                        </div>
                    </div>
                    ${deleteBtn}
                </div>
            `;
        });
    }

    // ‚úÖ H√†m t√≠nh th·ªùi gian t∆∞∆°ng ƒë·ªëi (V·ª´a xong, 5 ph√∫t tr∆∞·ªõc...)
    function formatTimeAgo(dateString) {
        const now = new Date();
        const past = new Date(dateString);
        const diffMs = now - past;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'V·ª´a xong';
        if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
        if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
        if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
        
        return past.toLocaleDateString('vi-VN');
    }

    // ‚úÖ H√†m x√≥a 1 l·ªãch s·ª≠
    async function deleteActivityLog(id) {
        if (!confirm('‚ö†Ô∏è X√≥a l·ªãch s·ª≠ ho·∫°t ƒë·ªông n√†y?')) return;
        const res = await apiCall(`/api/activities/${id}`, 'DELETE');
        if (res && res.success) {
            loadStats(); // Reload l·∫°i dashboard ƒë·ªÉ c·∫≠p nh·∫≠t list
        } else {
            alert('‚ùå ' + (res ? res.message : 'L·ªói x√≥a'));
        }
    }

    // ‚úÖ H√†m x√≥a T·∫§T C·∫¢ l·ªãch s·ª≠ (D√πng cho n√∫t trong tab C√†i ƒë·∫∑t)
    async function clearAllActivityLogs() {
        if (!confirm('‚ö†Ô∏è B·∫†N CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA T·∫§T C·∫¢ L·ªäCH S·ª¨?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
        const res = await apiCall('/api/activities/clear/all', 'DELETE');
        if (res && res.success) {
            alert('‚úÖ ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠');
            loadStats();
        } else {
            alert('‚ùå ' + (res ? res.message : 'L·ªói x√≥a'));
        }
    }

    async function loadMembers() {
        const grid = document.getElementById('membersGrid');
        if (!grid) return;
        
        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">‚è≥ ƒêang t·∫£i danh s√°ch th√†nh vi√™n...</p>';

        try {
            const res = await fetch('/api/members');
            const data = await res.json();
            
            // Ki·ªÉm tra success v√† l·∫•y m·∫£ng members t·ª´ data.members
            if (data.success && Array.isArray(data.members)) {
                allMembers = data.members; // L∆∞u l·∫°i ƒë·ªÉ d√πng cho vi·ªác t√¨m cha/m·∫π/v·ª£/ch·ªìng
                renderMembers(data.members);
            } else {
                throw new Error(data.error || "D·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng");
            }
        } catch (err) {
            console.error(err);
            grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:red;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${err.message}</p>`;
        }
    }

    function renderMembers(members) {
        const grid = document.getElementById('membersGrid');
        grid.innerHTML = '';

        if (!members || members.length === 0) {
            grid.innerHTML = '<p style="grid-column:1/-1; text-align:center;">Ch∆∞a c√≥ th√†nh vi√™n n√†o.</p>';
            return;
        }

        // ‚úÖ S·∫ÆP X·∫æP & GOM NH√ìM: ƒê·ªùi -> Order -> Ng√†y sinh -> V·ª£ ch·ªìng (Nam tr∆∞·ªõc)
        const sortedRaw = [...members].sort((a, b) => {
            // 1. Theo ƒë·ªùi
            const genDiff = (a.generation || 99) - (b.generation || 99);
            if (genDiff !== 0) return genDiff;
            
            // 2. Theo Order (n·∫øu c√≥)
            const orderA = (a.order !== undefined && a.order !== null) ? a.order : 9999;
            const orderB = (b.order !== undefined && b.order !== null) ? b.order : 9999;
            if (orderA !== orderB) return orderA - orderB;

            // 3. Theo ng√†y sinh
            return (a.birth_date || '9999').localeCompare(b.birth_date || '9999');
        });

        const finalMembers = [];
        const processedIds = new Set();

        sortedRaw.forEach(member => {
            const mId = member._id || member.id;
            if (processedIds.has(mId)) return;

            // X√°c ƒë·ªãnh gi·ªõi t√≠nh
            const gender = (member.gender || '').toLowerCase();
            const isMale = ['nam', 'male', 'trai'].includes(gender);

            // T√¨m v·ª£/ch·ªìng trong danh s√°ch hi·ªán t·∫°i (ƒë·ªÉ gom nh√≥m)
            let spouse = null;
            const spouseId = (member.spouse && (member.spouse._id || member.spouse.id)) || member.spouse_id;
            
            if (spouseId) {
                spouse = sortedRaw.find(s => (s._id || s.id) == spouseId);
            }

            if (spouse && !processedIds.has(spouse._id || spouse.id)) {
                // C·∫∑p ƒë√¥i ch∆∞a x·ª≠ l√Ω -> Gom nh√≥m (Nam tr∆∞·ªõc, N·ªØ sau)
                if (isMale) {
                    finalMembers.push(member);
                    finalMembers.push(spouse);
                } else {
                    finalMembers.push(spouse); // Ch·ªìng tr∆∞·ªõc
                    finalMembers.push(member); // V·ª£ sau
                }
                processedIds.add(mId);
                processedIds.add(spouse._id || spouse.id);
            } else {
                // ƒê·ªôc th√¢n ho·∫∑c v·ª£/ch·ªìng kh√¥ng trong list/ƒë√£ x·ª≠ l√Ω
                finalMembers.push(member);
                processedIds.add(mId);
            }
        });

        finalMembers.forEach(m => {
            const card = document.createElement('div');
            card.className = 'member-item';
            
            // Chu·∫©n h√≥a hi·ªÉn th·ªã gi·ªõi t√≠nh
            const genderLower = (m.gender || '').toLowerCase();
            const isMale = ['nam', 'male', 'trai'].includes(genderLower);
            const genderIcon = isMale ? '<i class="fas fa-mars"></i>' : '<i class="fas fa-venus"></i>';
            const genderText = isMale ? 'Nam' : 'N·ªØ';
            
            const aliveStatus = m.is_alive ? '<span style="color:green">C√≤n s·ªëng</span>' : '<span style="color:gray">ƒê√£ m·∫•t</span>';
            
            // T√¨m t√™n v·ª£/ch·ªìng ƒë·ªÉ hi·ªÉn th·ªã
            let spouseInfo = '';
            if (m.spouse_id) {
                const spouse = members.find(s => (s._id || s.id) == m.spouse_id);
                if (spouse) spouseInfo = `<p><i class="fas fa-heart" style="color: #ec4899;"></i> VC: <strong>${spouse.full_name}</strong></p>`;
            }

            card.innerHTML = `
                <div class="member-header">
                    <div class="member-avatar">${genderText}</div>
                    <span class="generation-badge-small">ƒê·ªùi th·ª© ${m.generation}</span>
                </div>
                <div class="member-details">
                    <h3>${m.full_name}</h3>
                    <div class="member-info">
                        <p>${genderIcon} ${genderText} - ${aliveStatus}</p>
                        <p><i class="fas fa-birthday-cake"></i> ${m.birth_date || '?'}</p>
                        ${spouseInfo}
                    </div>
                    <div class="member-actions">
                        <button class="btn-edit" onclick="openEditMemberModal('${m._id || m.id}')">S·ª≠a</button>
                        <button class="btn-delete" onclick="deleteMember('${m._id}')">X√≥a</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // --- SEARCH FUNCTION ---
    function setupSimpleSearch() {
        const searchInput = document.getElementById('searchInput');
        const filterType = document.getElementById('filterMemberType');
        
        if (!searchInput) return;

        const handleFilter = () => {
            const keyword = searchInput.value.toLowerCase().trim();
            const type = filterType ? filterType.value : 'all';

            const filtered = allMembers.filter(m => {
                const matchName = (m.full_name || '').toLowerCase().includes(keyword);
                const matchType = type === 'all' || (m.member_type === type);
                return matchName && matchType;
            });

            renderMembers(filtered);
        };

        searchInput.oninput = handleFilter;
        if (filterType) filterType.onchange = handleFilter;
    }

    async function deleteMember(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')) return;
        try {
            await fetch(`/api/members/${id}`, { method: 'DELETE' });
            loadMembers();
            loadStats();
        } catch (e) { alert('L·ªói x√≥a th√†nh vi√™n'); }
    }

    // --- TREE FUNCTIONS (M·ªöI) ---
    let treeRenderer;

    async function initTree() {
        // Ch·ªâ kh·ªüi t·∫°o 1 l·∫ßn
        if (treeRenderer) return;
        
        if (typeof FamilyTreeRenderer !== 'undefined') {
            treeRenderer = new FamilyTreeRenderer('familyTreeSvg');
            await populatePersonDropdown();
            // ‚úÖ M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã to√†n b·ªô c√¢y ngay khi kh·ªüi t·∫°o
            showFullFamilyTree();
        }
    }

    async function populatePersonDropdown() {
        const select = document.getElementById('personSelect');
        if (!select) return;
    
        let members = [];
        try {
            const res = await fetch('/api/members');
            const data = await res.json();
            if (data.success && Array.isArray(data.members)) {
                members = data.members;
            }
        } catch (e) { console.error("L·ªói load dropdown c√¢y", e); }
    
        // ‚úÖ CHUY·ªÇN ƒê·ªîI SELECT TH√ÄNH √î T√åM KI·∫æM
        if (select.tagName === 'SELECT') {
            const container = document.createElement('div');
            container.className = 'search-select-container';
            container.style.position = 'relative';
            container.style.display = 'inline-block';
            container.style.minWidth = '300px';
    
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.id = 'personSelectSearch';
            searchInput.className = 'btn-control';
            searchInput.placeholder = 'üîç G√µ t√™n ƒë·ªÉ t√¨m...';
            searchInput.style.width = '100%';
            searchInput.style.textAlign = 'left';
            searchInput.autocomplete = 'off';
            searchInput.style.backgroundColor = '#fff';
    
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'personSelect'; // Gi·ªØ ID c≈© ƒë·ªÉ code kh√°c v·∫´n ch·∫°y
            hiddenInput.value = '';
    
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'personSelectResults';
            resultsDiv.className = 'search-results';
            
            container.appendChild(searchInput);
            container.appendChild(hiddenInput);
            container.appendChild(resultsDiv);
            
            select.parentNode.replaceChild(container, select);
        }
    
        // ‚úÖ S·∫ÆP X·∫æP DANH S√ÅCH (∆Øu ti√™n Nam, ƒë·ªùi 1)
        const sortedMembers = members.sort((a, b) => {
            const genA = a.generation || 99, genB = b.generation || 99;
            if (genA !== genB) return genA - genB;
    
            if (genA === 1) {
                const isMaleA = (a.gender || '').toLowerCase().startsWith('nam');
                const isMaleB = (b.gender || '').toLowerCase().startsWith('nam');
                if (isMaleA && !isMaleB) return -1; // Nam tr∆∞·ªõc
                if (!isMaleA && isMaleB) return 1;  // N·ªØ sau
            }
    
            const orderA = a.order ?? 999, orderB = b.order ?? 999;
            if (orderA !== orderB) return orderA - orderB;
    
            return (a.full_name || '').localeCompare(b.full_name || '');
        });
    
        // K√≠ch ho·∫°t logic t√¨m ki·∫øm v·ªõi danh s√°ch ƒë√£ s·∫Øp x·∫øp
        setupSearchableDropdown('personSelectSearch', 'personSelect', 'personSelectResults', sortedMembers, showSelectedPersonTree);
    }

    async function showSelectedPersonTree() {
        const id = document.getElementById('personSelect').value;
        if (id && treeRenderer) {
            // ‚úÖ Fix: D√πng highlightInCurrentTree ƒë·ªÉ t√¨m v√† zoom v√†o ng∆∞·ªùi ƒë√≥
            if (typeof treeRenderer.highlightInCurrentTree === 'function') {
                await treeRenderer.highlightInCurrentTree(id);
            } else {
                await treeRenderer.render(id);
            }
        }
    }

    function showFullFamilyTree() {
        if (treeRenderer) treeRenderer.renderFullTree();
    }

    function resetTreeToCenter() {
        if (treeRenderer) {
            // ∆Øu ti√™n zoom v√†o target n·∫øu c√≥, ng∆∞·ª£c l·∫°i zoom to√†n b·ªô
            if (treeRenderer.targetPersonId) {
                treeRenderer.centerOnTarget();
            } else {
                treeRenderer.centerContent();
            }
        }
    }

    function resetZoom() {
        if (treeRenderer) treeRenderer.resetZoom();
    }

    function downloadTree() {
        if (treeRenderer) treeRenderer.exportPDF();
    }

    // --- POSTS LOGIC (B√ÄI VI·∫æT) ---
    let editingPostId = null;

    async function loadPosts() {
        const grid = document.getElementById('postsGrid');
        const empty = document.getElementById('postsEmptyState');
        if (!grid) return;

        try {
            const res = await apiCall('/api/posts');
            if (res && res.success) {
                renderPosts(res.posts);
            }
        } catch (e) { console.error("L·ªói load posts:", e); }
    }

    function renderPosts(posts) {
        const grid = document.getElementById('postsGrid');
        const empty = document.getElementById('postsEmptyState');
        grid.innerHTML = '';
        
        if (!posts || posts.length === 0) {
            grid.style.display = 'none';
            if (empty) empty.style.display = 'block';
            return;
        }
        
        grid.style.display = 'grid';
        if (empty) empty.style.display = 'none';

        // L·∫•y ID user hi·ªán t·∫°i ƒë·ªÉ check quy·ªÅn s·ª≠a/x√≥a
        const token = localStorage.getItem('authToken');
        let currentUserId = null;
        let currentUserRole = localStorage.getItem('userRole');
        if (token) {
            const parts = token.split('_');
            if (parts.length >= 2) currentUserId = parts[1];
        }

        posts.forEach(post => {
            const card = document.createElement('div');
            card.className = 'post-card';
            card.style.cssText = `background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;`;
            card.onmouseover = () => card.style.transform = 'translateY(-2px)';
            card.onmouseout = () => card.style.transform = 'none';
            card.onclick = () => viewPostDetail(post.id);

            const date = new Date(post.created_at).toLocaleDateString('vi-VN');
            const isOwner = currentUserRole === 'owner';
            // So s√°nh ID (chuy·ªÉn v·ªÅ string ƒë·ªÉ ch·∫Øc ch·∫Øn)
            const isAuthor = (String(post.author_id) === String(currentUserId));
            
            let actions = '';
            if (isOwner || isAuthor) {
                actions = `
                    <div style="display:flex; gap:8px;">
                        ${isAuthor ? `<button onclick="event.stopPropagation(); openEditPostModal('${post.id}')" class="btn-edit" style="padding:4px 8px; font-size:12px;">S·ª≠a</button>` : ''}
                        <button onclick="event.stopPropagation(); deletePost('${post.id}')" class="btn-delete" style="padding:4px 8px; font-size:12px;">X√≥a</button>
                    </div>
                `;
            }

            const icon = post.category === 'event' ? 'üéâ' : (post.category === 'news' ? 'üì∞' : 'üì¢');
            const pinned = post.is_pinned ? '<span style="color:#f97316">üìå</span> ' : '';

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:10px;">
                    <div>
                        <h3 style="margin:0; font-size:18px; color:#1f2937;">${pinned}${icon} ${post.title}</h3>
                        <div style="font-size:12px; color:#6b7280; margin-top:4px;">
                            <i class="fas fa-user"></i> ${post.author_name || '·∫®n danh'} ‚Ä¢ ${date}
                        </div>
                    </div>
                    ${actions}
                </div>
                <p style="color:#4b5563; font-size:14px; line-height:1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                    ${post.content}
                </p>
            `;
            grid.appendChild(card);
        });
    }

    function openCreatePostModal() {
        editingPostId = null;
        document.getElementById('postModalTitle').textContent = 'T·∫°o B√†i Vi·∫øt';
        document.getElementById('postForm').reset();
        document.getElementById('postModal').classList.add('active');
    }

    async function openEditPostModal(id) {
        editingPostId = id;
        document.getElementById('postModalTitle').textContent = 'S·ª≠a B√†i Vi·∫øt';
        
        const res = await apiCall(`/api/posts/${id}`);
        if (res && res.success) {
            const p = res.post;
            document.getElementById('postTitle').value = p.title;
            document.getElementById('postCategory').value = p.category;
            document.getElementById('postContent').value = p.content;
            document.getElementById('postPinned').checked = p.is_pinned;
            document.getElementById('postModal').classList.add('active');
        }
    }

    function closePostModal() {
        document.getElementById('postModal').classList.remove('active');
    }

    async function submitPostForm(e) {
        e.preventDefault();
        const data = {
            title: document.getElementById('postTitle').value,
            category: document.getElementById('postCategory').value,
            content: document.getElementById('postContent').value,
            is_pinned: document.getElementById('postPinned').checked
        };

        const url = editingPostId ? `/api/posts/${editingPostId}` : '/api/posts';
        const method = editingPostId ? 'PUT' : 'POST';

        const res = await apiCall(url, method, data);
        if (res && res.success) {
            alert('Th√†nh c√¥ng!');
            closePostModal();
            loadPosts();
        } else {
            alert('L·ªói: ' + (res ? res.message : 'Unknown'));
        }
    }

    async function deletePost(id) {
        if (!confirm('X√≥a b√†i vi·∫øt n√†y?')) return;
        const res = await apiCall(`/api/posts/${id}`, 'DELETE');
        if (res && res.success) {
            loadPosts();
        } else {
            alert('L·ªói x√≥a b√†i vi·∫øt');
        }
    }

    async function viewPostDetail(id) {
        const res = await apiCall(`/api/posts/${id}`);
        if (res && res.success) {
            const p = res.post;
            document.getElementById('viewPostTitle').textContent = p.title;
            document.getElementById('viewPostContent').textContent = p.content;
            
            // Hi·ªÉn th·ªã meta info
            const date = new Date(p.created_at).toLocaleDateString('vi-VN');
            const metaEl = document.getElementById('viewPostMeta');
            if(metaEl) {
                metaEl.innerHTML = `
                    <span><i class="fas fa-user"></i> ${p.author_name || 'Unknown'}</span>
                    <span>‚Ä¢</span>
                    <span><i class="fas fa-calendar"></i> ${date}</span>
                `;
            }
            
            document.getElementById('viewPostModal').classList.add('active');
        }
    }
    
    function closeViewPostModal() {
        document.getElementById('viewPostModal').classList.remove('active');
    }

    // --- MODAL & FORM FUNCTIONS ---

    function openAddMemberModal() { 
        editingMemberId = null;
        document.getElementById('addModalTitle').textContent = 'Th√™m Th√†nh Vi√™n';
        document.getElementById('memberForm').reset();
        
        document.getElementById('memberParent').value = '';
        document.getElementById('memberSpouse').value = '';
        document.getElementById('memberParentSearch').value = '';
        document.getElementById('memberSpouseSearch').value = '';
        
        setupSearchableDropdown('memberParentSearch', 'memberParent', 'memberParentResults', allMembers, updateGenerationLogic);
        setupSearchableDropdown('memberSpouseSearch', 'memberSpouse', 'memberSpouseResults', allMembers, updateGenerationLogic);
        
        updateGenerationLogic();
        document.getElementById('addMemberModal').classList.add('active'); 
    }

    function openEditMemberModal(id) {
        editingMemberId = id;
        document.getElementById('addModalTitle').textContent = 'S·ª≠a Th√†nh Vi√™n';
        
        const m = allMembers.find(x => (x._id || x.id) == id);
        if (!m) return alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin');

        document.getElementById('memberName').value = m.full_name;
        document.getElementById('memberGender').value = m.gender;
        document.getElementById('memberBirth').value = m.birth_date || '';
        document.getElementById('memberDeath').value = m.death_date === 'unknown' ? '' : (m.death_date || '');
        document.getElementById('isDeceasedUnknown').checked = (m.is_alive === false && m.death_date === 'unknown');
        document.getElementById('memberPhone').value = m.phone || '';
    document.getElementById('memberOrder').value = (m.order !== undefined && m.order !== null) ? m.order : ''; // Load Order
        document.getElementById('memberJob').value = m.job || '';
        document.getElementById('memberAddress').value = m.address || '';
        document.getElementById('memberNote').value = m.notes || '';

        const others = allMembers.filter(x => (x._id || x.id) != id);
        setupSearchableDropdown('memberParentSearch', 'memberParent', 'memberParentResults', others, updateGenerationLogic);
        setupSearchableDropdown('memberSpouseSearch', 'memberSpouse', 'memberSpouseResults', others, updateGenerationLogic);

        // Populate Parent/Spouse names
        const parent = m.parent_id ? allMembers.find(x => (x._id || x.id) == m.parent_id) : null;
        document.getElementById('memberParentSearch').value = parent ? parent.full_name : '';
        document.getElementById('memberParent').value = m.parent_id || '';

        const spouse = m.spouse_id ? allMembers.find(x => (x._id || x.id) == m.spouse_id) : null;
        document.getElementById('memberSpouseSearch').value = spouse ? spouse.full_name : '';
        document.getElementById('memberSpouse').value = m.spouse_id || '';

        updateGenerationLogic();
        document.getElementById('memberGeneration').value = m.generation;

        document.getElementById('addMemberModal').classList.add('active');
    }

    function closeAddMemberModal() { document.getElementById('addMemberModal').classList.remove('active'); }
    
    // --- ADVANCED SEARCH FUNCTIONS ---
    async function openAdvancedSearch() { 
        document.getElementById('advancedSearchForm').reset();
        await loadGenerationOptions();
        document.getElementById('advancedSearchModal').classList.add('active'); 
    }
    
    function closeAdvancedSearch() { document.getElementById('advancedSearchModal').classList.remove('active'); }
    
    function resetAdvancedSearch() {
        document.getElementById('advancedSearchForm').reset();
        renderMembers(allMembers); // Reset v·ªÅ danh s√°ch g·ªëc
    }

    async function loadGenerationOptions() {
        const select = document.getElementById('searchGeneration');
        if (!select) return;
        
        // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n (-- T·∫•t c·∫£ --)
        select.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
        
        // L·∫•y max generation t·ª´ stats ho·∫∑c t√≠nh t·ª´ allMembers
        let maxGen = 0;
        if (allMembers.length > 0) {
            maxGen = Math.max(...allMembers.map(m => m.generation || 0));
        }
        
        for (let i = 1; i <= maxGen; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = `Th·∫ø h·ªá ${i}`;
            select.appendChild(opt);
        }
    }

    async function performAdvancedSearch() {
        const filters = {
            name: document.getElementById('searchName').value.trim(),
            generation: document.getElementById('searchGeneration').value,
            gender: document.getElementById('searchGender').value,
            status: document.getElementById('searchStatus').value,
            job: document.getElementById('searchJob').value.trim(),
            ageMin: document.getElementById('searchAgeMin').value,
            ageMax: document.getElementById('searchAgeMax').value,
            address: document.getElementById('searchAddress').value.trim()
        };

        const res = await apiCall('/api/members/search', 'POST', filters);
        if (res && res.success) {
            renderMembers(res.members);
            closeAdvancedSearch();
            alert(`T√¨m th·∫•y ${res.count} k·∫øt qu·∫£.`);
        } else {
            alert('L·ªói t√¨m ki·∫øm');
        }
    }

    function setupSearchableDropdown(searchInputId, hiddenInputId, resultsId, data, onSelect) {
        const searchInput = document.getElementById(searchInputId);
        const hiddenInput = document.getElementById(hiddenInputId);
        const resultsDiv = document.getElementById(resultsId);

        if (!searchInput) return;

        // ‚úÖ X√≥a listener c≈© ƒë·ªÉ tr√°nh l·ªói click ƒë√∫p
        if (searchInput._closeListener) {
            document.removeEventListener('click', searchInput._closeListener);
        }

        const closeListener = (e) => {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        };
        document.addEventListener('click', closeListener);
        searchInput._closeListener = closeListener; // L∆∞u l·∫°i ƒë·ªÉ x√≥a sau n√†y

        searchInput.oninput = () => {
            const keyword = searchInput.value.toLowerCase().trim();
            hiddenInput.value = ''; 
            if (onSelect) onSelect();

            // Logic l·ªçc d·ªØ li·ªáu (Hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu kh√¥ng c√≥ t·ª´ kh√≥a)
            let currentFiltered = data;
            if (keyword) {
                currentFiltered = data.filter(m => m.full_name.toLowerCase().includes(keyword));
            }
            
            resultsDiv.innerHTML = '';
            
            if (currentFiltered.length === 0) { 
                resultsDiv.innerHTML = '<div class="search-item" style="color:#999; cursor:default;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                resultsDiv.style.display = 'block'; 
                return; 
            }

            // Gi·ªõi h·∫°n hi·ªÉn th·ªã 50 k·∫øt qu·∫£ ƒë·∫ßu ti√™n ƒë·ªÉ tr√°nh lag
            currentFiltered.slice(0, 50).forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<strong>${item.full_name}</strong> <small>ƒê·ªùi th·ª© ${item.generation}</small>`;
                div.onclick = () => {
                    searchInput.value = item.full_name;
                    hiddenInput.value = item._id || item.id;
                    resultsDiv.style.display = 'none';
                    if (onSelect) onSelect();
                };
                resultsDiv.appendChild(div);
            });
            resultsDiv.style.display = 'block';
        };
        
        searchInput.onfocus = searchInput.oninput;
        // ‚úÖ FIX: Khi click v√†o √¥ t√¨m ki·∫øm th√¨ hi·ªán danh s√°ch ngay
        searchInput.onfocus = () => searchInput.dispatchEvent(new Event('input'));
    }

    function updateGenerationLogic() {
        const parentId = document.getElementById('memberParent').value;
        const spouseId = document.getElementById('memberSpouse').value;
        const genSelect = document.getElementById('memberGeneration');
        
        if (parentId) {
            const parent = allMembers.find(m => (m._id || m.id) == parentId);
            if (parent) {
                const gen = (parent.generation || 1) + 1;
                genSelect.innerHTML = `<option value="${gen}">Th·∫ø h·ªá ${gen} (Con)</option>`;
                return;
            }
        } else if (spouseId) {
            const spouse = allMembers.find(m => (m._id || m.id) == spouseId);
            if (spouse) {
                const gen = spouse.generation || 1;
                genSelect.innerHTML = `<option value="${gen}">Th·∫ø h·ªá ${gen} (V·ª£/Ch·ªìng)</option>`;
                return;
            }
        }
        
        genSelect.innerHTML = '<option value="1">Th·∫ø h·ªá 1 (Th·ªßy t·ªï)</option><option value="2">Th·∫ø h·ªá 2</option><option value="3">Th·∫ø h·ªá 3</option>';
    }

    async function submitMemberForm(e) {
        e.preventDefault();
        
        const parentId = document.getElementById('memberParent').value;
        const spouseId = document.getElementById('memberSpouse').value;
        const generation = document.getElementById('memberGeneration').value;
        
        if (generation != '1' && !parentId && !spouseId) {
             alert('Th√†nh vi√™n ƒë·ªùi > 1 ph·∫£i c√≥ Cha/M·∫π ho·∫∑c V·ª£/Ch·ªìng li√™n k·∫øt.');
             return;
        }

        const isDeceasedUnknown = document.getElementById('isDeceasedUnknown').checked;
        let death_date = document.getElementById('memberDeath').value;
        let is_alive = true;

        if (death_date) {
            is_alive = false;
        } else if (isDeceasedUnknown) {
            death_date = 'unknown';
            is_alive = false;
        }

        const formData = {
            full_name: document.getElementById('memberName').value,
            gender: document.getElementById('memberGender').value,
            birth_date: document.getElementById('memberBirth').value,
            death_date: death_date,
            is_alive: is_alive,
            phone: document.getElementById('memberPhone').value,
            order: document.getElementById('memberOrder').value ? parseInt(document.getElementById('memberOrder').value) : null, // Save Order
            generation: parseInt(generation),
            job: document.getElementById('memberJob').value,
            address: document.getElementById('memberAddress').value,
            notes: document.getElementById('memberNote').value,
            parent_id: parentId || null,
            spouse_id: spouseId || null,
            member_type: parentId ? 'blood' : (spouseId ? 'in_law' : 'blood')
        };
        
        if (generation == 1) formData.member_type = 'blood';

        const url = editingMemberId ? `/api/members/${editingMemberId}` : '/api/members';
        const method = editingMemberId ? 'PUT' : 'POST';
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (res.ok) {
                alert('L∆∞u th√†nh c√¥ng!');
                closeAddMemberModal();
                loadMembers();
                loadStats();
            } else {
                const err = await res.json();
                alert('L·ªói: ' + (err.error || err.message));
            }
        } catch (e) {
            console.error(e);
            alert('L·ªói k·∫øt n·ªëi server');
        }
    }

    // --- SETTINGS FUNCTIONS (M·ªöI) ---

    function downloadSampleCSV() {
        // Th√™m BOM ƒë·ªÉ Excel hi·ªÉn th·ªã ƒë√∫ng ti·∫øng Vi·ªát
        const BOM = "\uFEFF"; 
        const csvContent = BOM + "full_name,gender,birth_date,death_date,generation,notes,phone,job,address,parent_name,spouse_name\n" +
            "Nguy·ªÖn VƒÉn A,Nam,1950-01-01,,1,Th·ªßy t·ªï,,,,,\n" +
            "Tr·∫ßn Th·ªã B,N·ªØ,1955-05-05,,1,V·ª£ c·ª• A,,,H√† N·ªôi,,Nguy·ªÖn VƒÉn A\n" +
            "Nguy·ªÖn VƒÉn C,Nam,1980-10-10,,2,Con tr∆∞·ªüng,,,H√† N·ªôi,Nguy·ªÖn VƒÉn A,";
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "mau_nhap_lieu_giapha.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function importData() {
        // T·∫°o input file ·∫©n ƒë·ªÉ ch·ªçn file
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.csv';
        
        input.onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            alert("‚è≥ ƒêang x·ª≠ l√Ω import, vui l√≤ng ch·ªù...");

            try {
                const res = await fetch('/api/settings/import-csv', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    let msg = `‚úÖ Import ho√†n t·∫•t!\n- Th√†nh c√¥ng: ${data.successCount}\n- L·ªói/B·ªè qua: ${data.errorCount}`;
                    if (data.errors && data.errors.length > 0) {
                        msg += "\n\nM·ªôt s·ªë l·ªói:\n" + data.errors.slice(0, 5).join("\n");
                    }
                    alert(msg);
                    loadMembers(); // T·∫£i l·∫°i danh s√°ch
                    loadStats();   // T·∫£i l·∫°i th·ªëng k√™
                } else {
                    alert("‚ùå L·ªói import: " + (data.message || "Kh√¥ng x√°c ƒë·ªãnh"));
                }
            } catch (err) {
                console.error(err);
                alert("‚ùå L·ªói k·∫øt n·ªëi server");
            }
        };

        input.click();
    }

    async function resetData() {
        if (!confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω X√ìA TO√ÄN B·ªò th√†nh vi√™n v√† kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u.\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?")) return;
        
        try {
            const res = await fetch('/api/settings/reset-data', { method: 'POST' });
            if (res.ok) {
                await fetch('/api/seed'); // T·∫°o l·∫°i d·ªØ li·ªáu m·∫´u
                alert("‚úÖ ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu m·∫´u th√†nh c√¥ng!");
                loadMembers();
                loadStats();
            } else {
                alert("L·ªói khi reset d·ªØ li·ªáu");
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi");
        }
    }

    function exportPDF() {
        alert("üí° Vui l√≤ng chuy·ªÉn sang tab 'C√¢y Gia Ph·∫£' v√† s·ª≠ d·ª•ng n√∫t 'T·∫£i xu·ªëng' ƒë·ªÉ xu·∫•t PDF bi·ªÉu ƒë·ªì.");
    }
</script>
</body>
</html>